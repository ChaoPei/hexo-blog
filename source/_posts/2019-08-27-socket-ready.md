---
title: Socket 读写就绪条件
date: 2019-08-27 15:07:38
update: 2019-08-27 15:07:38
categories: [Linux]
tags: [Linux, socket, read, write, unix]
---

关于 Socket 的读写就绪条件。

<!-- more -->

我们知道 Socket 读写都是有缓冲区，而且读写时阻塞的，因此通常用 I/O 多路复用来监听多个 Socket 的就绪。这个就绪是十分有意思的，内核是如何得知某个 Socket 就绪了呢？引用《Unix网络编程》中的解释：

当满足下列条件之一时，一个套接字准备好读：

- 该套接字接收缓冲区中的数据字节数大于等于套接字接收缓冲区低水位标记的当前大小。对这样的套接字执行读操作不会阻塞并将返回一个大于 0 的值（也就是返回准备好读入的数据）。我们可以使用 `SO_RCVLOWAT` 套接字选项设置该套接字的低水位标记。对于 TCP 和 UDP 套接字而言，其默认值为 1。
- 该连接的读半部关闭（也就是接收了 FIN 的 TCP 连接）。对这样的套接字的读操作将不阻塞并返回 0 （也就是返回 EOF）。
- 该套接字是一个监听套接字且已完成的连接数不为 0。对这样的套接字的 accept 通常不会阻塞。
- 其上有一个套接字错误待处理。对这样的套接字的读操作将不阻塞并返回 -1（也就是返回一个错误），同时把 `errno` 设置成确切的错误条件。这些待处理错误也可以通过指定 `SO_ERROR` 套接字选项调用 `getsockopt` 获取并清除。

当满足下列条件之一时，一个套接字准备好写：

- 该套接字发送缓冲区中的可用空间字节数大于等于套接字发送缓冲区低水位标记的当前大小，并且要求该套接字已连接（TCP）或者不需要连接（UDP）。这意味着如果我们把这样的套接字设置为非阻塞，写操作将不阻塞并返回一个正值（例如由传输层接收的字节数）。我们可以使用 `SO_SNDLOWAT` 套接字选项来设置该套接字的低水位标记。对于 TCP 和 UDP 套接字而言，其默认值通常为 2048。
- 该连接的写半部关闭，对这样的套接字的写操作将产生 `SIGPIPE` 信号。
- 使用非阻塞式 `connect` 的套接字已建立连接，或者已经以失败告终。
- 其上有一个套接字错误待处理。对这样的套接字的写操作将不阻塞并返回 -1（也就是返回一个错误），同时把 `errno` 设置成确切的错误条件。这些待处理的错误也可以通过指定 `SO_ERROR` 套接字选项调用 `getsockopt` 获取并清除。

另外，如果一个套接字存在带外数据或者仍处于带外标记，那么它有异常条件待处理。从上面可以看出，如果一个套接字发生错误，那么它是可读可写条件。

可以看出，读写就绪条件一般情况（非异常）都是内核通过判断缓冲区中是否有数据。因为网络上数据的到来是随时的，因此当缓冲区中有网络的数据（大于 1），说明可读。而写数据则将数据积攒起来，大于低水位或者发送方主动关闭了连接，才会通过网络发送出去。